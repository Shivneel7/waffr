---
title: "Figures: Yearly changes"
author: "asmtry"
output: html_document
---
  
```{r setupKnitr, include = FALSE}
knitr::opts_knit$set(echo = TRUE, root.dir = normalizePath('../'), warning = TRUE, collapse = TRUE)
#knitr::opts_chunk$set(cache=TRUE)
```

This worksheet leans heavily on `tidyverse` packages.

```{r setupEnv, include=FALSE}
source("R/utilities.R")
pkgTest("ggedit", "ggalt", "ggrepel", "ggthemes", "gridExtra", "cowplot", "viridis",
        "tidyverse", "lubridate", "tools", "readr", "broom", "devtools")
install_github("wilkox/ggfittext")
install_github("wilkox/treemapify")
ggplot2::theme_set(theme_bw())
```

# Setup

Import data
```{r importData}
cdl.table <- read_csv("input/TABLES/cdl_crops.csv")                                       # Crop names/attributes
roi.table <- read_csv("input/SHAPEFILES/cnty24k09_poly/cnty24k09_poly_attributes.csv")    # County names/attributes
wf.master.cyear <- readRDS("output/wfs/wf_total_cyr.rds")
wf.master.wyear <- readRDS("output/wfs/wf_total_wyr.rds")
yield.master <- read_csv("output/yields/NASS_summarized_bycounty.csv")
```

# Create some functions for commonly used summary statistics

Typially in a boxplot, outliers are marked as values that fall outside of 1.5 times the interquartile range 
avove and below the 25% and 75% quantiles. `is_extreme()` is a function that we define below, that applys the
same criteria and returns TRUE if the value is a suspected outlier/extreme falue, and false otherwise.

```{r}
is_extreme <- function(x) {
  return(x < (quantile(x, 0.25) - (1.5 * IQR(x)) ) | x > (quantile(x, 0.75) + (1.5 * IQR(x)) ))
}

wf.master.wyear <- wf.master.wyear[!(wf.master.wyear$cdl.name == "Oats" & wf.master.wyear$County == "Riverside" & wf.master.wyear$Year == 2009),]
wf.master.cyear <- wf.master.wyear[!(wf.master.cyear$cdl.name == "Oats" & wf.master.cyear$County == "Riverside" & wf.master.cyear$Year == 2009),]
```

# Figure: Average water demand by crop PER year
## Calculate average for each year

```{r}
wf.master.bycrop.cyear <- wf.master.cyear %>%
  mutate(Year = as.Date(sprintf("%s-01-01", Year), format="%F")) %>%
  group_by(cdl.value, cdl.name, Year) %>%
  summarize_at(vars(cwr, ppt, et.b, et.g, wf.b, wf.g), funs(avg = "sum")) %>%
  left_join(cdl.table %>% select(value,`FAO_shortgroup`),
            by = c("cdl.value" = "value")) %>%
  ungroup()

wf.master.bycrop.wyear <- wf.master.wyear %>%
  mutate(Year = as.Date(sprintf("%s-01-01", Year), format="%F")) %>%
  group_by(cdl.value, cdl.name, Year) %>%
  summarize_at(vars(cwr, ppt, et.b, et.g, wf.b, wf.g), funs(avg = "sum")) %>%
  left_join(cdl.table %>% 
              select(value,`FAO_shortgroup`),
            by = c("cdl.value" = "value")) %>%
  ungroup()

wf.master.byFAO.wyear <- wf.master.wyear %>%
  left_join(cdl.table %>% 
              select(value,`FAO_shortgroup`),
            by = c("cdl.value" = "value")) %>%
  mutate(Year = as.Date(sprintf("%s-01-01", Year), format="%F")) %>%
  group_by(FAO_shortgroup, Year) %>%
  summarize_at(vars(cwr, ppt, et.b, et.g, wf.b, wf.g), funs(avg = "mean")) %>%
  ungroup()
```

## Plot average Blue WF crop-wise

```{r, eval=FALSE, include=FALSE}
ggplot(data = wf.master.bycrop.wyear) +
  geom_point(mapping = aes(x = Year, y = wf.b, color = cdl.name)) +
  labs(title = "Mean WF by crop for 2007 - 2015 calendar years",
      subtitle = "Top 1% (overall) WF crops labled",
      x = "Calendar Year", y = "Average annual Blue WF (m3/tonne)", 
      color = "Crop Name")
```

It looks like there is some extreme outlier crop. Let's see what it is, by labeling the top 99th
percentile crops by Blue WF. Note that we're just tagging entries in the top 99% *overall*, not the
top 99% by year.

```{r}
wf.master.bycrop.cyear %>%
  group_by(Year) %>%
  mutate(percentile = percent_rank(wf.b_avg)) %>%
  ggplot() +
  geom_point(mapping = aes(x = Year, y = wf.b_avg, color = cdl.name)) +
  geom_label_repel(mapping = aes(x = Year, y = wf.b_avg, 
                                 label = ifelse(percentile > 0.99, cdl.name, NA), 
                                 fill = cdl.name), 
                   color = "white", segment.color = 'grey', box.padding = unit(0.35, "lines"), 
                   point.padding = unit(0.5, "lines"), na.rm = TRUE) +
  labs(title = "Mean WF by crop for 2007 - 2015 calendar years",
      subtitle = "Top 1% (overall) WF crops labled",
      x = "Calendar Year", y = "Average annual Blue WF (m3/tonne)", 
      color = "Crop Name") +
  guides(fill = "none")

wf.master.bycrop.wyear %>%
  group_by(Year) %>%
  mutate(percentile = percent_rank(wf.b_avg)) %>%
  ggplot() +
  geom_point(mapping = aes(x = Year, y = wf.b_avg, color = cdl.name)) +
  geom_label_repel(mapping = aes(x = Year, y = wf.b_avg, 
                                 label = ifelse(percentile > 0.99, cdl.name, NA), 
                                 fill = cdl.name), 
                   color = "white", segment.color = 'grey', box.padding = unit(0.35, "lines"), 
                   point.padding = unit(0.5, "lines"), na.rm = TRUE) +
  labs(title = "Mean WF by crop for 2008 - 2015 water years",
      subtitle = "Top 1% (overall) WF crops labled",
      x = "Water Year", y = "Average annual Blue WF (m3/tonne)", 
      color = "Crop Name") +
  guides(fill = "none")
```

Note how different year aggregrations change the ranking of crops. I am not sure what to make 
out of this. The growing season for mint (from BIS) is from April to August, but certain tree crops 
(cherries, walnuts) have an irrigation season that gets partially split differently depending on 
how the year is split (calendar vs water year).

Let's see if the same signal appears when considering the crop water use alone. Also, let's only
focus on **water years** from now on.

```{r}
# Let's focus on water years from now on
wf.master.bycrop.wyear %>%
  group_by(Year) %>%
  mutate(percentile = percent_rank(cwr_avg)) %>%
  ggplot() +
  geom_point(mapping = aes(x = Year, y = cwr_avg, color = cdl.name)) +
  geom_label_repel(mapping = aes(x = Year, y = cwr_avg, 
                                 label = ifelse(percentile > 0.95, cdl.name, NA), 
                                 fill = cdl.name), 
                   color = "white", segment.color = 'grey', box.padding = unit(0.35, "lines"), 
                   point.padding = unit(0.5, "lines"), na.rm = TRUE) +
  scale_x_date(date_breaks = "1 years", date_labels = "%Y") +
  #scale_x_continuous(breaks = function(x) floor(x))) +
  #scale_x_discrete(labels = Year) +
  scale_y_continuous(labels = scales::comma) +
  labs(title = "Mean CWR by crop for 2008 - 2015 water years",
      subtitle = "Top 5% (overall) CWR crops labled",
      x = "Water Year", y = "Average Crop Water Requirement (m3)", 
      color = "Crop Name") +
  theme(axis.text.y = element_text(angle = 90)) +
  guides(fill = "none")
```

With alfalfa beating rest in regard to water requirement, there are no surprises there. Let's try 
to examine trends among individual crops or commodity groups.

First, let's consider the average CWR for commodity groups, by year.

```{r}
wf.master.byFAO.wyear %>%
  ggplot() +
  geom_point(mapping = aes(x = Year, y = cwr_avg, color = FAO_shortgroup)) +
  geom_line(mapping = aes(x = Year, y = cwr_avg, color = FAO_shortgroup)) +
  geom_label_repel(mapping = aes(x = Year, y = cwr_avg, 
                                 label = ifelse(Year == max(wf.master.byFAO.wyear[["Year"]]),FAO_shortgroup,NA), 
                                 color = FAO_shortgroup), 
                   box.padding = unit(0.35, "lines"), 
                   point.padding = unit(0.5, "lines"), nudge_x = 1000, na.rm = TRUE) +
  scale_x_date(date_breaks = "1 years", date_labels = "%Y") +
  scale_y_continuous(labels = scales::comma) +
  expand_limits(x = as.Date("2016-01-01")) +
  labs(title = "Mean CWR by crop for 2008 - 2015 water years",
      subtitle = "Top 5% (overall) CWR crops labled",
      x = "Water Year", y = "Average Crop Water Requirement (m3)", 
      color = "Crop Name") +
  theme(axis.text.y = element_text(angle = 90), legend.position="none") +
  guides(fill = "none")
```

Next, let's consider the average CWR for for individual crops, by year.
```{r}
wf.master.bycrop.wyear %>%
  ggplot() +
  geom_point(mapping = aes(x = Year, y = cwr_avg, color = cdl.name)) +
  geom_line(mapping = aes(x = Year, y = cwr_avg, color = cdl.name)) +
  geom_label_repel(mapping = aes(x = Year, y = cwr_avg, 
                                 label = ifelse(Year == max(wf.master.byFAO.wyear[["Year"]]),cdl.name,NA), 
                                 color = cdl.name), 
                   box.padding = unit(0.35, "lines"), 
                   point.padding = unit(0.5, "lines"), nudge_x = 35, na.rm = TRUE) +
  scale_x_date(date_breaks = "1 years", date_labels = "%Y") +
  scale_y_continuous(labels = scales::comma) +
  expand_limits(x = as.Date("2016-01-01")) +
  labs(title = "Mean CWR by crop for 2008 - 2015 water years",
      subtitle = "Top 5% (overall) CWR crops labled",
      x = "Water Year", y = "Average Crop Water Requirement (m3)", 
      color = "Crop Name") +
  theme(axis.text.y = element_text(angle = 90), legend.position="none") +
  guides(fill = "none")
```

It's a bit difficult to distinguish over 50 different crops on one plot, so we can create sub-plots
based on FAO commodity groups, using `ggplot2`'s built-in faceting.
```{r fig.height=12}
wf.master.bycrop.wyear %>%
  ggplot() +
  geom_point(mapping = aes(x = Year, y = cwr_avg, color = cdl.name)) +
  facet_wrap(~FAO_shortgroup, ncol = 2, scales = "free") +
  geom_line(mapping = aes(x = Year, y = cwr_avg, color = cdl.name)) +
  geom_label_repel(mapping = aes(x = Year, y = cwr_avg, 
                                 label = ifelse(Year == max(wf.master.byFAO.wyear[["Year"]]),cdl.name,NA), 
                                 color = cdl.name), 
                   box.padding = unit(0.25, "lines"), 
                   point.padding = unit(0.4, "lines"), nudge_x = 35, na.rm = TRUE, size = 2) +
  scale_x_date(date_breaks = "1 years", date_labels = "%Y") +
  scale_y_continuous(labels = scales::comma) +
  expand_limits(x = as.Date("2016-01-01")) +
  labs(title = "Mean CWR by crop for 2008 - 2015 water years",
      subtitle = "Top 5% (overall) CWR crops labled",
      x = "Water Year", y = "Average Crop Water Requirement (m3)", 
      color = "Crop Name") +
  theme(axis.text.y = element_text(angle = 90), legend.position="none") +
  guides(fill = "none")
```

# Figure: Average water demand by county for all years
## Calculate average for all years

```{r, eval=FALSE, include=FALSE}
wf.master.bycrop.cyear <- wf.master.cyear %>%
  mutate(Year = as.Date(sprintf("%s-01-01", Year), format="%F")) %>%
  group_by(roi.index, County, Year) %>%
  summarize_at(vars(cwr, ppt, et.b, et.g, wf.b, wf.g), funs(avg = "sum")) %>%
  left_join(roi.table %>% select(value,`FAO_shortgroup`),
            by = c("roi.index" = "NUM")) %>%
  ungroup()

wf.master.bycrop.wyear <- wf.master.wyear %>%
  mutate(Year = as.Date(sprintf("%s-01-01", Year), format="%F")) %>%
  group_by(roi.index, County, Year) %>%
  summarize_at(vars(cwr, ppt, et.b, et.g, wf.b, wf.g), funs(avg = "sum")) %>%
  left_join(roi.table %>% 
              select(value,`FAO_shortgroup`),
            by =c("roi.index" = "NUM")) %>%
  ungroup()

wf.master.byFAO.wyear <- wf.master.wyear %>%
  left_join(roi.table %>% 
              select(NUM,`HR_NAME`),
            by = c("roi.index" = "NUM")) %>%
  group_by(FAO_shortgroup, Year) %>%
  summarize_at(vars(cwr, ppt, et.b, et.g, wf.b, wf.g), funs(avg = "sum")) %>%
  mutate(Year = as.Date(sprintf("%s-01-01", Year), format="%F")) %>%
  ungroup()
```





# Specific analysis; walnuts
```{r}
t2 <- yield.master[yield.master$cdl.name == "Walnuts",]

t3 <- yield.master[yield.master$cdl.name == "Walnuts",] %>%
  group_by(County) %>%
  summarize_at(vars(prod.tons, val.usd, hvst.acres, prod.tonne), funs("sum"))

yield.master[yield.master$cdl.name == "Walnuts",] %>%
  ggplot() +
  geom_point(mapping = aes(x = Year, y = prod.tons, color = County)) +
  geom_line(mapping = aes(x = Year, y = prod.tons, color = County))
  geom_label_repel(mapping = aes(x = Year, y = prod.tons, 
                                 label = County, 
                                 fill = County), 
                   color = "white", segment.color = 'grey', box.padding = unit(0.35, "lines"), 
                   point.padding = unit(0.5, "lines"), na.rm = TRUE) +
    

wf.master.bycrop.wyear %>%
  group_by(Year) %>%
  mutate(percentile = percent_rank(wf.b_avg)) %>%
  ggplot() +
  geom_point(mapping = aes(x = Year, y = wf.b_avg, color = cdl.name)) +
  geom_label_repel(mapping = aes(x = Year, y = wf.b_avg, 
                                 label = ifelse(percentile > 0.99, cdl.name, NA), 
                                 fill = cdl.name), 
                   color = "white", segment.color = 'grey', box.padding = unit(0.35, "lines"), 
                   point.padding = unit(0.5, "lines"), na.rm = TRUE) +
  labs(title = "Mean WF by crop for 2008 - 2015 water years",
      subtitle = "Top 1% (overall) WF crops labled",
      x = "Water Year", y = "Average annual Blue WF (m3/tonne)", 
      color = "Crop Name") +
  guides(fill = "none")

```





