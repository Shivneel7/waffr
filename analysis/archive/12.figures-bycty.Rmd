---
title: "Figures: Yearly changes"
author: "asmtry"
output: html_document
---
  
```{r setupKnitr, include = FALSE}
knitr::opts_knit$set(echo = TRUE, root.dir = normalizePath('../'), warning = TRUE, collapse = TRUE)
knitr::opts_chunk$set(cache=TRUE)
```

This worksheet leans heavily on `tidyverse` packages.

```{r setupEnv, include=FALSE}
source("R/utilities.R")
pkgTest("ggedit", "ggalt", "ggrepel", "ggthemes", "gridExtra", "cowplot", "viridis",
        "tidyverse", "lubridate", "tools", "readr", "broom", "knitr", "devtools",
        "rgdal")
install_github("wilkox/ggfittext")
install_github("wilkox/treemapify")
# pkgTest repeated for the non-CRAN packages, because knitr breaks otherwise
pkgTest("ggfittext", "treemapify")
ggplot2::theme_set(theme_bw())
```

# Setup

Import data
```{r importData}
cdl.table <- read_csv("input/TABLES/cdl_crops.csv")                                       # Crop names/attributes
roi.table <- read_csv("input/SHAPEFILES/cnty24k09_poly/cnty24k09_poly_attributes.csv")    # County names/attributes
ca.counties <- readOGR("input/SHAPEFILES/cnty24k09_poly/cnty24k09_poly_simple.shp")
wf.master.cyear <- readRDS("output/wfs/wf_total_cyr.rds")
wf.master.wyear <- readRDS("output/wfs/wf_total_wyr.rds")
yield.master <- read_csv("output/yields/NASS_summarized_bycounty.csv")
```

# Create some functions for commonly used summary statistics

Typially in a boxplot, outliers are marked as values that fall outside of 1.5 times the interquartile range 
avove and below the 25% and 75% quantiles. `is_extreme()` is a function that we define below, that applys the
same criteria and returns TRUE if the value is a suspected outlier/extreme falue, and false otherwise.

```{r}
is_extreme <- function(x) {
  return(x < (quantile(x, 0.25) - (1.5 * IQR(x)) ) | x > (quantile(x, 0.75) + (1.5 * IQR(x)) ))
}

# TMP: Remove problematic entries
wf.master.wyear <- wf.master.wyear[!(wf.master.wyear$cdl.name == "Oats" & wf.master.wyear$County == "Riverside" & wf.master.wyear$Year == 2009),]
wf.master.cyear <- wf.master.cyear[!(wf.master.cyear$cdl.name == "Oats" & wf.master.cyear$County == "Riverside" & wf.master.cyear$Year == 2009),]
```

# Figure: Total water demand by county PER year
## Calculate total for each year

```{r}
wf.master.bycounty.cyear <- wf.master.cyear %>%
  mutate(Year = as.Date(sprintf("%s-01-01", Year), format="%F")) %>%
  group_by(roi.index, County, Year) %>%
  summarize_at(vars(cwr, ppt, hvst.acres, prod.tons, et.b, et.g, wf.b, wf.g), funs(avg = "sum")) %>%
  left_join(roi.table %>% select(NUM,`HR_NAME`),
            by = c("roi.index" = "NUM")) %>%
  ungroup()

wf.master.bycounty.wyear <- wf.master.wyear %>%
  mutate(Year = as.Date(sprintf("%s-01-01", Year), format="%F")) %>%
  group_by(roi.index, County, Year) %>%
  summarize_at(vars(cwr, ppt, hvst.acres, prod.tons, et.b, et.g, wf.b, wf.g), funs(avg = "sum")) %>%
  left_join(roi.table %>% select(NUM,`HR_NAME`),
            by = c("roi.index" = "NUM")) %>%
  ungroup()

wf.master.byHR.wyear <- wf.master.wyear %>%
  left_join(roi.table %>% select(NUM,`HR_NAME`),
            by = c("roi.index" = "NUM")) %>%
  mutate(Year = as.Date(sprintf("%s-01-01", Year), format="%F")) %>%
  group_by(`HR_NAME`, Year) %>%
  summarize_at(vars(cwr, ppt, hvst.acres, prod.tons, et.b, et.g, wf.b, wf.g), funs(avg = "sum")) %>%
  ungroup()
```

## Plot total Blue WF county-wise

```{r, eval=FALSE, include=FALSE}
ggplot(data = wf.master.bycounty.cyear) +
  geom_point(mapping = aes(x = Year, y = wf.b_avg, color = County)) +
  labs(title = "Mean WF by county for 2007 - 2015 CALENDAR years",
      x = "Calendar Year", y = "Average annual Blue WF (m3/tonne)", 
      color = "County")
```

It looks like there is some extreme outlier crop. Let's see what it is, by labeling the top 99th
percentile crops by Blue WF. Note that we're just tagging entries in the top 99% *overall*, not the
top 99% by year.

```{r, fig.height=6, fig.width=10}
wf.master.bycounty.cyear %>%
  group_by(Year) %>%
  mutate(percentile = percent_rank(wf.b_avg)) %>%
  ggplot() +
  geom_point(mapping = aes(x = Year, y = wf.b_avg, color = County)) +
  geom_label_repel(mapping = aes(x = Year, y = wf.b_avg, 
                                 label = ifelse(percentile > 0.99, County, NA), 
                                 fill = County), 
                   color = "white", segment.color = 'grey', box.padding = unit(0.35, "lines"), 
                   point.padding = unit(0.5, "lines"), na.rm = TRUE) +
  labs(title = "Mean WF by county for 2007 - 2015 CALENDAR years",
      subtitle = "Top 1% (overall) WF crops labled",
      x = "Calendar Year", y = "Total annual Blue WF (m3/tonne)", 
      color = "County") +
  guides(fill = "none")

wf.master.bycounty.wyear %>%
  group_by(Year) %>%
  mutate(percentile = percent_rank(wf.b_avg)) %>%
  ggplot() +
  geom_point(mapping = aes(x = Year, y = wf.b_avg, color = County)) +
  geom_label_repel(mapping = aes(x = Year, y = wf.b_avg, 
                                 label = ifelse(percentile > 0.99, County, NA), 
                                 fill = County), 
                   color = "white", segment.color = 'grey', box.padding = unit(0.35, "lines"), 
                   point.padding = unit(0.5, "lines"), na.rm = TRUE) +
  labs(title = "Total Blue WF by county for 2008 - 2015 water years",
      subtitle = "Top 1% (overall) WF crops labled",
      x = "Water Year", y = "Total annual Blue WF (m3/tonne)", 
      color = "County") +
  guides(fill = "none") +
  theme(axis.text.y = element_text(angle = 90), legend.position="none")
```

Note how different year aggregrations change the ranking of crops. I am not sure what to make 
out of this. The growing season for mint (from BIS) is from April to August, but certain tree crops 
(cherries, walnuts) have an irrigation season that gets partially split differently depending on 
how the year is split (calendar vs water year).

## Plot total CWR county-wise

Plotting crop water use by county, per year.

```{r, fig.height=6, fig.width=10}
wf.master.bycounty.wyear %>%
  group_by(Year) %>%
  mutate(percentile = percent_rank(cwr_avg)) %>%
  ggplot() +
  geom_point(mapping = aes(x = Year, y = cwr_avg, color = County)) +
  geom_label_repel(mapping = aes(x = Year, y = cwr_avg, 
                                 label = ifelse(percentile > 0.95, County, NA), 
                                 fill = County), 
                   color = "white", segment.color = 'grey', box.padding = unit(0.35, "lines"), 
                   point.padding = unit(0.5, "lines"), na.rm = TRUE) +
  labs(title = "Total CWR by county for 2008 - 2015 water years",
      subtitle = "Top 5% (overall) WF counties labled",
      x = "Water Year", y = "Total annual Blue WF (m3/tonne)", 
      color = "County") +
  guides(fill = "none") +
  theme(axis.text.y = element_text(angle = 90), legend.position="none")
```

Plotting harveted acres by county, per year.

```{r, fig.height=6, fig.width=10}
wf.master.bycounty.wyear %>%
  group_by(Year) %>%
  mutate(percentile = percent_rank(hvst.acres_avg)) %>%
  ggplot() +
  geom_point(mapping = aes(x = Year, y = hvst.acres_avg, color = County)) +
  geom_label_repel(mapping = aes(x = Year, y = hvst.acres_avg, 
                                 label = ifelse(percentile > 0.95, County, NA), 
                                 fill = County), 
                   color = "white", segment.color = 'grey', box.padding = unit(0.35, "lines"), 
                   point.padding = unit(0.5, "lines"), na.rm = TRUE) +
  labs(title = "Harvested Acres by county for 2008 - 2015 water years",
      subtitle = "Top 5% (overall) WF counties labled",
      x = "Water Year", y = "Total annual harvested acres (acres)", 
      color = "County") +
  guides(fill = "none") +
  theme(axis.text.y = element_text(angle = 90), legend.position="none")
```

Plotting production mass by county, per year.
```{r, fig.height=6, fig.width=10}
wf.master.bycounty.wyear %>%
  group_by(Year) %>%
  mutate(percentile = percent_rank(prod.tons_avg)) %>%
  ggplot() +
  geom_point(mapping = aes(x = Year, y = prod.tons_avg, color = County)) +
  geom_label_repel(mapping = aes(x = Year, y = prod.tons_avg, 
                                 label = ifelse(percentile > 0.95, County, NA), 
                                 fill = County), 
                   color = "white", segment.color = 'grey', box.padding = unit(0.35, "lines"), 
                   point.padding = unit(0.5, "lines"), na.rm = TRUE) +
  labs(title = "Production by county for 2008 - 2015 water years",
      subtitle = "Top 5% (overall) WF counties labled",
      x = "Water Year", y = "Total annual harvested mass (Tons US)", 
      color = "County") +
  guides(fill = "none") +
  theme(axis.text.y = element_text(angle = 90), legend.position="none")
```
